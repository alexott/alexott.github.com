<html><head><meta http-equiv="Content-Type" content="text/html; charset=koi8-r"><title>Настройка Gnus для обработки спама</title><meta name="generator" content="DocBook XSL Stylesheets V1.67.2"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article" lang="ru"><div class="titlepage"><div><div><h1 class="title"><a name="id2407254"></a>Настройка Gnus для обработки спама</h1></div><div><div class="author"><h3 class="author"><span class="firstname">Alex</span> <span class="surname">Ott</span></h3><div class="affiliation"><div class="address"><p><br>
	  <code class="email">&lt;<a href="mailto:ottalex@narod.ru">ottalex@narod.ru</a>&gt;</code><br>
	</p></div></div></div></div></div><hr></div><div class="toc"><p><b>Содержание</b></p><dl><dt><span class="section"><a href="#id2451062">Базовые понятия</a></span></dt><dt><span class="section"><a href="#id2451127">Обработка спама</a></span></dt><dd><dl><dt><span class="section"><a href="#id2451130">Основы настройки</a></span></dt><dt><span class="section"><a href="#id2451283">Схема обработки спама</a></span></dt><dt><span class="section"><a href="#id2451416">Методы обработки спама</a></span></dt></dl></dd><dt><span class="section"><a href="#id2450698">Настройка</a></span></dt><dd><dl><dt><span class="section"><a href="#id2450760">Настройка конкретных методов пакета spam</a></span></dt><dt><span class="section"><a href="#id2452395">Другие методы обработки</a></span></dt></dl></dd><dt><span class="section"><a href="#id2452492">Благодарности</a></span></dt></dl></div><p>Данная статья является небольшим введением в технологию борьбы со спамом средствами пакета Gnus. Данная статья основывается на возможностях пакета, которые появились начиная с ветки Oort Gnus, существуют в текущей стабильной версии 5.10.x и сейчас развивается в версии NoGnus.</p><div class="section" lang="ru"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2451062"></a>Базовые понятия</h2></div></div></div><p>Для правильного понимания того, как производить настройку и
    работать с Gnus, необходимо уточнить некоторые понятия:

    </p><div class="glosslist"><dl><dt>пометка (mark)</dt><dd><p>символьный атрибут, который устанавливается на статью;</p></dd><dt>функция разбиения (splitter)</dt><dd><p>функция, которая для каждого письма должна вернуть имя группы в которую его необходимо перенести, или nil, если продолжать обработку дальше;</p></dd><dt>хук (hook)</dt><dd><p>функция, выполняемая при возникновении какого-то условия и включении/выключении режима. Используется для предоставления пользователю возможности выполнять дополнительную настройку или другие действия.</p></dd></dl></div><p>
    </p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2451127"></a>Обработка спама</h2></div></div></div><div class="section" lang="ru"><div class="titlepage"><div><div><h3 class="title"><a name="id2451130"></a>Основы настройки</h3></div></div></div><p>Настройка анти-спама производится в несколько этапов, для
      выполнения которых необходимо в файл <code class="filename">~/.gnus</code>
      добавить несколько команд:

      </p><div class="orderedlist"><ol type="1"><li><p>Сначала надо задать метод обработки. Gnus предоставляет несколько методов, которые могут быть использованы для определения спама &#8212;  статистический метод, bogofilter, ifile,
	черные и белые списки адресов.  Для статистического метода команда
	задания будет выглядеть так:

   </p><pre class="screen">(setq spam-install-hooks t) ;; заставим установить все нужные хуки
(setq spam-use-stat t) ;; мы будем использовать статистический метод
</pre><p>
	</p></li><li><p>Затем необходимо загрузить нужные модули Gnus:

	</p><pre class="screen">(require 'spam-stat) ;; для использования spam-stat
(require 'spam)
</pre><p>
	</p></li><li><p>Теперь надо выполнять проверку входящей почты на
	содержание спама. Обычно при обработке спама используется
	fancy-разбиение, которое позволяет использовать произвольный код
	ELisp внутри обработчика.  Так, например, для nnmail разбиение будет
	выглядеть так (минимальная версия):

	</p><pre class="screen">(setq nnmail-split-methods 'nnmail-split-fancy)
(setq nnmail-split-fancy
      '(|
          ;; перехватываем спам
          (: spam-split)
          ;; все остальное кладем в папку inbox
          "inbox"))
</pre><p>
   
Аналогичным образом может быть настроена и функция разбиения для метода
доступа nnimap.
	</p></li><li><p>После этого, при обработке почты письма, определенные как спам, будут идти в специальную группу "spam", значение которой пользователь может переопределить.</p></li><li><p>Однако, особено в начале эксплуатации, спам все равно может проходить сквозь фильтры. Поэтому, пользователь может вручную помечать письма содержащие спам, и при выходе из группы для этих писем будет вызываться обработчик, специфический для конкретного метода обработки спама &#8212; spam-stat, bogofilter, ifile и другие. После этого, указанные спамерские письма будут учитываться при обработке следующих писем.</p></li></ol></div><p>
      </p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h3 class="title"><a name="id2451283"></a>Схема обработки спама</h3></div></div></div><p>Схема обработки почты Gnus'ом показана на рисунке <a href="#emacs.gnus.spam.schema">Схема обработки почты</a>.
    </p><div class="figure-float"><div class="figure"><a name="emacs.gnus.spam.schema"></a><p class="title"><b>Рисунок 1. Схема обработки почты</b></p><div class="screenshot"><div class="mediaobject"><img src="gnus-spam-ru.png" alt="Схема обработки почты"></div></div></div></div><p>

    Здесь можно выделить несколько этапов:

    </p><div class="orderedlist"><ol type="1"><li><p>Новая почта получается из настроенных источников и передается на обработку в функцию разбиения. Функция разбиения, кроме прочих задач, настроена еще и на обнаружение спама (эта часть показана в виде выбора "Спам?");</p></li><li><p>В функции разбиения принимается решение о том к какой группе отнести обрабатываемое письмо. В зависимости от решения, письмо перемещается либо в группу для спама (красная, пунктирная черта), либо в группу для обычной не классифицированной почты. Эти операции производятся автоматически;</p></li><li><p>Затем, пользователь читает почту из группы с обычной
      почтой, и помечает спам (обычно это выполняется с помощью клавиши
      <span class="keysym">M</span>-<span class="keysym">d</span>);</p></li><li><p>После выхода из группы с обычными письмами происходит обработка оставшихся писем с помощью соответствующих процессоров. Письма помеченные как спам передаются на обработку процессору спама, и затем помечаются как expirable, или перемещаются в другую группу. А обычные письма передаются другому процессору, которые добавляет обычные письма в соответствующую базу.</p></li></ol></div><p>

   </p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h3 class="title"><a name="id2451416"></a>Методы обработки спама</h3></div></div></div><p>Gnus поддерживает разные методы и программы для определения
    писем со спамом. Вот список поддерживаемых методов:

    </p><div class="itemizedlist"><ul type="disc"><li><p>Черные и белые списки. Позволяют пользователю задавать списки адресов, которые будет считаться либо спамом (черный список), либо нормальным письмом (белый список). У данного метода есть несколько вариантов, как например белые списки из BBDB, когда все письма с адресов, которые имеются в BBDB рассматриваются как нормальная почта. Также есть модификация данного метода, когда в качестве признака нормальных писем используются токены Hashcash, а не почтовые адреса. Кроме этого, черные списки могут получаться из внешних источников;</p></li><li><p>Соответствие заголовков регулярным выражениям. Данный метод позволяет пользователю задавать регулярные выражения, относительно которых будут проверяться заголовки писем, и по этим признакам письмо будет относится к нормальным письмам или письмам со спамом;</p></li><li><p>Внешние программы &#8212; bogofilter, ifile и SpamOracle. В качестве фильтра спама используются соответствующие программы, которым для корректировки работы передаются письма вручную помеченные пользователем. Эти программы являются разными реализациями анти-спамовых систем на основе алгоритма Байеса;</p></li><li><p>Spam-stat. Собственная реализация алгоритма Баейса на
      Emacs Lisp.  Работает на любой платформе, на которой существует Emacs,
      но медленнее чем соответствующие аналоги, и требует работы больше
      оперативной памяти<sup>[<a name="id2451507" href="#ftn.id2451507">1</a>]</sup>.</p></li></ul></div><p>

    </p></div></div><div class="section" lang="ru"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="id2450698"></a>Настройка</h2></div></div></div><p>Настройка обработчиков писем со спамом и нормальных писем (как и
    прочих параметров обработки спама) производится с помощью параметров из
    группы spam (используйте
    <span class="keysym">M</span>-<span class="keysym">x</span>
    <span><strong class="command">customize-group</strong></span>
    <code class="computeroutput">spam</code>). В этой группе настройки
    пользователь может вручную указать какой метод обработки использовать,
    куда складывать письма со спамом, а также другие параметры.</p><p>Настройку обработки спама можно разделить на две большие группы &#8212; использование возможностей пакета spam и использование комбинации стандартных возможностей Gnus.</p><div class="section" lang="ru"><div class="titlepage"><div><div><h3 class="title"><a name="id2450760"></a>Настройка конкретных методов пакета spam</h3></div></div></div><p>Как уже упоминалось выше, настройка конкретных методов обработки спама производится установкой переменной, соответствующей нужному методу. Ниже перечислены имена соответствующих переменных, а также приведены дополнительные настройки для конкретных методов.</p><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2450783"></a>spam-stat</h4></div></div></div><p>При использовании метода spam-stat настройка может выглядеть
	так:
    
	</p><pre class="screen">;; устанавливаем параметры, метод обработки и загружаем модули
(setq spam-install-hooks t)
(setq spam-use-stat t)
(require 'spam-stat)
(require 'spam)
;; загружаем файл со статистикой по словам
(when (file-exists-p spam-stat-file)
  (spam-stat-load))
;; задаем имя группы для спама
(setq spam-stat-split-fancy-spam-group "spam")

;; А эта функция нужна в основном для первоначального обучения 
;; байесовского фильтра.
(defun my-spam-stat-learn ()
  "Learn about my spam and non-spam"
  (interactive)
  (let ((starting (current-time-string)))
    ;; обрабатываем спам
    (spam-stat-process-spam-directory "~/Mail/spam")
    ;; обрабатываем нормальные письма из разных каталогов
    (let ((ham-groups '("inbox" "Gnus-ding" "Emacs")))
      (mapc (lambda (x)
              (spam-stat-process-non-spam-directory
               (format "~/Mail/%s" x)))
            ham-groups))
    (spam-stat-reduce-size)
    (spam-stat-save)
    (message "my-spam-stat-learn:  started at %s, ended at %s"
             starting (current-time-string))))
</pre><p>
	
	</p><p>Часто у пользователя уже есть письма со спамом.  Для обучения
	по ним, и предназначена функция my-spam-stat-learn, которую можно
	вызвать интерактивно. Предполагается, что спам хранится в каталоге
	<code class="filename">~/Mail/spam</code>, а нормальные письма берутся из
	каталогов <code class="filename">~/Mail/inbox</code>,
	<code class="filename">~/Mail/Gnus-ding</code> и
	<code class="filename">~/Mail/Emacs</code> (вы можете подставить пути к своим
	каталогам, или удалить лишние записи в списке ("inbox" "Gnus-ding"
	"Emacs")). Функцию <code class="function">my-spam-stat-learn</code> достаточно запустить один раз, при этом сформируется база с весами слов, и затем она будет дополняться по результатам ручной обработки почты &#8212;  через соответствующие обработчики при выходе из
	группы.</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2450887"></a>Черные и белые списки</h4></div></div></div><p>Для использования черных или белых списков надо присвоить
	истинное значение одной из переменных:

	</p><div class="variablelist"><dl><dt><span class="term"><code class="varname">spam-use-blacklist</code></span></dt><dd><p>для использования черных списков, когда письма от отправителя, чей адрес находится в черном списке, будут считаться спамом и отправляться в соответствующую группу;</p></dd><dt><span class="term"><code class="varname">spam-use-whitelist</code></span></dt><dd><p>для использования белых списков. В этом случае, письма от пользователей, адресов от которых нет в указанном списке, передаются следующему обработчику спама;</p></dd><dt><span class="term"><code class="varname">spam-use-whitelist-exclusive</code></span></dt><dd><p>для неявного использования белых списков. При использовании данного метода, письма от отправителей не перечисленных в белом списке, будут рассматриваться как спам. Осторожно используйте данный метод.</p></dd></dl></div><p>
	</p><p>Вы можете явно задать значения в файлах с белыми и черными
	списками, отредактировав файлы, на которые ссылаются переменные
	<code class="varname">spam-whitelist</code> и
	<code class="varname">spam-blacklist</code>.</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2450979"></a>Белые списки из BBDB</h4></div></div></div><p>Данный метод аналогичен по работе использованию белых списков,
	но белые списки при этом берутся из базы <a href="http://bbdb.sf.net" target="_top">BBDB</a>.  Аналогично обычным белым
	спискам, для настройки используются две переменных:
	<code class="varname">spam-use-BBDB</code> и
	<code class="varname">spam-use-BBDB-exclusive</code>, которые заставляют
	Gnus работать также, как и при использовании
	<code class="varname">spam-use-whitelist</code> и
	<code class="varname">spam-use-whitelist-exclusive</code>.
	</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2451018"></a>Внешние источники черных списков (blackholes)</h4></div></div></div><p>Gnus может проверять адреса в письмах относительно внешних,
	распределенных систем обработки спама. Для включения данного метода,
	вам необходимо присвоить истинное значение переменной
	spam-use-blackholes, например так:

	</p><pre class="screen">(setq spam-use-blackholes t)
</pre><p>
	
	Кроме этого, пользователь может указать список серверов,
	относительно которых будет производиться проверка (с помощью
	переменной
	<code class="varname">spam-blackhole-servers</code>)<sup>[<a name="id2452222" href="#ftn.id2452222">2</a>]</sup>.
	</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2452228"></a>Соответствие заголовков регулярным выражениям</h4></div></div></div><p>Данный метод позволяет пользователю использовать регулярные выражения для проверки заголовков писем. Пользователь может использовать регулярные выражения как для определения писем со спамом, так и для определения нормальных писем.</p><p>Для использования данного метода нужно установить в истинное
	значение переменную spam-use-regex-headers.  Переменные
	spam-regex-headers-spam и spam-regex-headers-ham должны содержать в
	себе списки регулярных выражений для спама и обычной
	почты<sup>[<a name="id2452265" href="#ftn.id2452265">3</a>]</sup>.</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2452272"></a>Обработка спама с помощью bogofilter</h4></div></div></div><p>Для данной программы возможно использование двух
	взаимоисключающих вариантов подключения. Первый вариант, который
	управляется переменной <code class="varname">spam-use-bogofilter</code>,
	запускает bogofilter для обрабатываемого письма и использует
	накопленную базу статистики. Второй метод, который включается
	переменной <code class="varname">spam-use-bogofilter-headers</code>, при
	фильтрации использует уже установленный заголовок
	<code class="computeroutput">X-Bogosity</code> (например, он может быть
	установлен во время обработки письма с помощью
	<span class="application">procmail</span>).  Для использования одного из
	методов, необходимо установить соответствующую переменную в истинное
	значение.</p><p>Кроме основных переменных, включающих данный метод,
	пользователь имеет возможно задать расположение баз bogofilter.  Оно
	задается с помощью переменной
	<code class="varname">spam-bogofilter-database-directory</code>.</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2452334"></a>Обработка спама с помощью ifile</h4></div></div></div><p>Использование ifile выполняется путем присвоения истинного
	значения переменной <code class="varname">spam-use-ifile</code>. Кроме того,
	как и в случае с bogofilter, с помощью переменной
	<code class="varname">spam-ifile-database-path</code> пользователь может
	задать путь к базам ifile.</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2452355"></a>Обработка спама с помощью SpamOracle</h4></div></div></div><p>Аналогично другим методам, использующим внешние программы,
	настройка SpamOracle производится установкой переменной с именем
	<code class="varname">spam-use-spamoracle</code>. Пользователь также может
	задать путь к базе SpamOracle с помощью переменной
	<code class="varname">spam-spamoracle-database</code>.</p></div><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2452377"></a>Дополнительные методы</h4></div></div></div><p>Кроме перечисленных методов Gnus позволяет пользователю достаточно просто добавить свои обработчики спама. Для того, чтобы узнать как это делать, прочитайте раздел "Extending the Spam ELisp package" в руководстве Gnus.</p></div></div><div class="section" lang="ru"><div class="titlepage"><div><div><h3 class="title"><a name="id2452395"></a>Другие методы обработки</h3></div></div></div><p>Кроме использования пакета spam, можно фильтровать спам и с
      помощью других средств. Например, так выполняется фильтрация спама при
      помощи <span class="application">SpamAssassin</span>.</p><div class="section" lang="ru"><div class="titlepage"><div><div><h4 class="title"><a name="id2452411"></a>Обработка спама с помощью SpamAssassin</h4></div></div></div><p>Данный метод напрямую не использует пакет spam, а использует стандартные возможности Gnus, такие как выполнение команд при заборе почты, и стандартные средства разбиения почты по заголовкам.</p><p>Сначала необходимо внести изменения в настройку источников
	почты. Нужно добавить обработчики
	<code class="computeroutput">:prescript</code> и
	<code class="computeroutput">:postscript</code>, используя команды,
	аналогичные приведенным в примере:
	</p><pre class="screen">(setq mail-sources
      '((file :prescript "formail -bs spamassassin &lt; /var/mail/%u")
        (pop :user "testuser"
             :server "myhost"
             :postscript
             "mv %t /tmp/testuserfile; formail -bs spamc &lt; /tmp/testuserfile &gt; %t")))
</pre><p>

	Это приведет к тому, что у пользователя окажется почта, в которой
	вставлены дополнительные заголовки SpamAssassin.
	</p><p>Затем пользователь может использовать стандартные средства
	разбиения почты, проверяя наличие заголовка
	<code class="computeroutput">X-Spam-Flag</code>, как это показано в
	примере: 
	</p><pre class="screen">(setq nnmail-split-methods '(("spam"  "^X-Spam-Flag: YES")
                             ...))
</pre><p>
	</p></div></div></div><div class="section"
	lang="ru"><div class="titlepage"><div><div><h2 class="title"
	style="clear:
	both"><a
	name="id2452492"></a>Благодарности</h2></div></div></div><p>Хочется
	выразить благодарность всей группе разработчиков Gnus за многолетнюю
	работу по созданию такого замечательного продукта. А также
	подписчикам списка рассылки Gnus, где в обсуждениях рождаются новые
	идеи.</p><p>Отдельное спасибо моей жене, за терпение и
	понимание!</p></div><div class="footnotes"><br><hr width="100"
	align="left"><div class="footnote"><p><sup>[<a name="ftn.id2451507"
	href="#id2451507">1</a>] </sup>По собственному опыту могу заметить,
	что этот метод очень эффективно отлавливает спам. За неделю сквозь
	фильтр проходит 1-2 писем со спамом, при общем потоке спама в
	100-200 писем в неделю (того, который не ловится внешним
	SpamAssassin).</p></div><div
	class="footnote"><p><sup>[<a name="ftn.id2452222"
	href="#id2452222">2</a>] </sup>Для данного метода не предусмотрено
	обработчиков спама и нормальной
	почты.</p></div><div
	class="footnote"><p><sup>[<a name="ftn.id2452265"
	href="#id2452265">3</a>] </sup>Для данного метода не предусмотрено
	обработчиков спама и нормальной почты.</p></div></div></div>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
	_uacct = "UA-78697-3";
	urchinTracker();
</script>
</body></html>
