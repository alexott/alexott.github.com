#title Использование Emacs для работы с электронной почтой и новостями  Usenet
#keywords emacs, xemacs, gnu emacs, gnus, news, mail, почта, емакс, гнус, новости usenet, usenet, altlinux

<contents>

#intro
* Введение

В этом документе рассказывается о том, как можно использовать Emacs для работы с
электронной почтой и новостями Usenet. В статье упоминается GNU Emacs, но практически всё
сказанное справедливо и для XEmacs.

Достаточно подробный список пакетов для работы с почтой вы можете [[http://www.emacswiki.org/cgi-bin/wiki.pl?GettingMail][найти]] на сервере
[[http://www.emacswiki.org/][EmacsWiki]]

* Пакет *Gnus*

*Gnus* -- это пакет Emacs, разработанный в первую очередь для чтения и отправки новостей
Usenet. Его также можно использовать для чтения и написания ответов на сообщения из многих
других источников -- почты, удалённых каталогов, дайджестов и других источников
данных. Большой набор заметок о *Gnus* вы сможете найти в
[[http://www.emacswiki.org/cgi-bin/wiki.pl?CategoryGnus][соответствующем разделе]]
EmacsWiki.

** Буфера *Gnus*

Для показа информации и получения команд *Gnus* использует несколько разных буферов. Большую
часть времени пользователи проводят в трех буферах -- *буфере групп*, *буфере резюме* и *буфере
статьи*.

*Буфер групп* содержит перечень групп. Это первый буфер, который Gnus показывает после
запуска. Обычно в нем показаны только те группы, на которые вы подписаны, и в которых есть
непрочитанные статьи. Используйте этот буфер для выбора конкретной группы.

*Буфер резюме* построчно перечисляет статьи одной группы. По умолчанию для каждой статьи
показываются автор, заголовок и число строк, но это можно настроить по своему вкусу, как и
большую часть того, что отображает *Gnus*. Буфер резюме создается, когда вы выбираете группу
в буфере групп, и уничтожается, когда вы покидаете эту группу. Используйте этот буфер для
выбора статьи.

*Буфер статьи* отображает саму статью. При обычном использовании *Gnus* вы не выбираете этот
буфер -- все полезные команды, предназначенные для работы над статьей, прекрасно работают
и из буфера резюме. Но вы можете выбрать буфер статьи и выполнять все команды *Gnus* из
него, если вы этого хотите.

** Запуск *Gnus*

Для запуска *Gnus* просто наберите =M-x gnus=. При запуске *Gnus* считывает ваш файл
инициализации новостей =.newsrc= и пытается установить связь с локальным сервером новостей,
который служит хранилищем статей. Сервер новостей не обязан быть тем же компьютером, на
который вы вошли.

Если вы запустили *Gnus* и соединились с сервером, но не видите в буфере групп ни одной
группы, наберите =L= или =A k=, чтобы получить список всех доступных групп. Затем нажимайте =u=
на нужной вам группе, чтобы переключать подписку на данную группу.

Когда вы запускаете *Gnus* первый раз, он подписывает вас на несколько избранных групп. Все
остальные группы сначала невидимы для вас; вы можете получить их список с помощью
последовательности клавиш =A k=. Все новые группы, появляющиеся в дальнейшем на сервере,
становятся для вас "зомбированными"; чтобы получить их перечень наберите =A z=. Вы можете
подписаться на группы, показанные в этих списках, используя команду =u=.

Когда вы покидаете *Gnus* при помощи команды =q=, то он автоматически записывает в ваших
файлах инициализации =.newsrc= и =.newsrc.eld= статус подписки всех групп. Обычно вам не стоит
редактировать эти файлы вручную, но вы можете это сделать, если точно уверены в том, что
надо в них писать.

** Работа с *Gnus*

Для чтения статей из конкретной группы, надо просто установить курсор на нужную группу и
нажать на клавишу пробела. При этом будет открыт буфер резюме, в котором будет отображен
список непрочитанных статей и отображена первая непрочитанная вами статья. Если
непрочитанных статей слишком много, то *Gnus* выдаст запрос о том, сколько статей необходимо
отобразить. Переменная =gnus-large-newsgroup= определяет пороговое значение, при превышении
которого группа будет считаться большой и будет выдаваться предупреждение.

Если вам необходимо увидеть и прочитанные статьи, то для их выбора вам нужно использовать
комбинацию =C-u space=. Кроме того, после префиксной комбинации вы можете указать число,
которое определит количество выбираемых статей. Положительное число *N* выбирает *N* самых
последних статей, а отрицательное число -- *N* самых старых статей. Например, =C-u - 5 0
space= выберет 50 самых старых статей.

** Настройка *Gnus* для работы с электронной почтой

*Gnus* обрабатывает почту точно также, как и новости Usenet. Для того чтобы читать
электронную почту в *Gnus*, надо просто задать метод для обработки почты и источники её
получения. Это определяется с помощью следующего кода в вашем файле =~/.emacs= или =~/.gnus=
(этот файл используется только для инициализации *Gnus*):

<src lang="emacs-lisp">
  (setq gnus-secondary-select-methods '((nnml "")))
  (setq mail-sources
  '((file :path "/var/spool/mail/user-name")
  (pop :server "pop3.mail.server"
  :user "user-name"
  :port "pop3"
  :password "secret")))
</src>

Первая строка задает список вторичных методов получения новостей для *Gnus*. В нашем примере
этот список состоит только из одного элемента -- =nnml=, который задает метод для чтения
почты. Вторая и последующая строки перечисляют источники получения почты. Переменная
=mail-sources= содержит список, каждый элемент которого является списком, в котором первый
элемент указывает на тип источника почты, а затем идет список ключевых слов и значений для
них. Список ключевых слов зависит от типа источника почты и полное их описание вы можете
найти в справке по *Gnus*. В нашем примере задаётся два источника почты.  Первый -- это
локальный файл с почтой, который задается путем =/var/spool/mail/user-name=, а второй
источник -- это POP3-сервер, для которого указывается большее количество ключевых слов,
описывающих параметры подключения к данному серверу. Будьте внимательны, помещая пароль
для доступа к почте в ваш файл настройки Emacs: если вы хотите хранить в нём ваш пароль,
то запретите чтение этого файла для всех остальных пользователей вашей системы.

*Gnus* обладает очень богатыми возможностями по разбиению почты на группы. Его возможности
позволяют разбить почту по множеству признаков. Разбиение почты на группы зависит от
содержимого переменной =nnmail-split-methods=, которая содержит список списков, состоящих из
пар строк -- имени группы и регулярного выражения, при соответствии которому сообщение
помещается в соответствующую группу.  Следующий код продемонстрирует простой пример
обработки входящей почты:

<src lang="emacs-lisp">
  (setq nnmail-split-methods '(
  ("ALT-sisyphus" "^\\(To\\|From\\|Cc\\):.*sisyphus@altlinux\\.ru.*")
  ("ALT-devel" "^\\(To\\|From\\|Cc\\):.*devel@altlinux\\.ru.*")
  ("inbox" "")))
</src>

В этом примере создается три группы. В первые две группы помещаются сообщения только из
списков рассылки *ALTLinux Sisyphus* и *ALTLinux Devel*. В группу *inbox* помещаются все
остальные сообщения, для которых не было совпадения по регулярным выражениям.

Чтобы создать новое почтовое сообщение просто нажмите на клавишу =m= в буфере групп или
буфере резюме. При этом будет отображено новое окно, в котором вы можете ввести адрес
получателя и тему сообщения, а также сам текст сообщения. Текст сообщения должен идти
после строки

<example>
--text follows this line--
</example>

Все, что находится до этой строки, рассматривается как заголовки. Это позволяет вам
вручную задавать дополнительные заголовки, такие как *Bcc*. Часть заголовков может
подставляться автоматически. К примеру, чтобы все отправляемые сообщения складывались в
отдельную группу, вам необходимо вписать в ваш файл инициализации следующий код:

<src lang="emacs-lisp">
(setq gnus-outgoing-message-group "nnml:sent")
</src>

После установки этой переменной, все отправляемые сообщения будут помещаться в группу
*sent*, доступ к которой осуществляется с помощью метода *nnml*.

** Другие возможности *Gnus*

В предыдущем тексте была описана лишь малая часть возможностей *Gnus*. Кроме обычных групп
для почты и новостей, *Gnus* позволяет создавать виртуальные группы, которые состоят из
частей других групп. Также можно отображать в виде групп новостей результаты поиска в
Интернете, серверы каталогов и прочее.

Кроме того, *Gnus* обладает мощными средствами по фильтрации и удалению ненужных вам
сообщений. Работа этого средства основана на подсчёте весов сообщения (Scoring). Веса
могут добавляться или удаляться в зависимости от текста и заголовка сообщения, его авторов
и многих других параметров. Это позволяет эффективно работать с новостями, читая только
то, что необходимо.
      
*Gnus* также умеет взаимодействовать с разными системами определения нежелательных почтовых
рассылок, позволяя вам не отвлекаться на ненужную вам почту.

#rmail
* Пакет *Rmail*

Этот пакет поставляется вместе с GNU Emacs и предназначен для чтения и хранения получаемой
вами почты. Для запуска этого пакета достаточно просто набрать =M-x rmail=. При этом будет
прочитан файл с почтой *Rmail* (обычно это =~/RMAIL=), забрана почта из ваших почтовых ящиков,
и отображено первое непрочитанное вами сообщение.

Emacs использует сужение для того, чтобы отображать только одно сообщение в каждый
отдельно взятый момент времени. Внутри файла *Rmail* сообщения располагаются в порядке их
поступления в ваши почтовые ящики. Вы также можете указать другие методы сортировки
сообщений.

Кроме основного файла с сообщениями *Rmail* вы можете создавать и использовать другие файлы
с сообщениями. Почта в эти файлы может поступать из других почтовых ящиков или из своего
основного файла *Rmail*.

*Rmail* предоставляет пользователю возможность назначения меток на конкретные почтовые
сообщения, или группы сообщений. Обычно метки используются для классификации
сообщений. Затем эти метки можно использовать для сортировки писем, или для перемещения их
в другие файлы *Rmail*.

Более подробную информацию о пакете *Rmail* можно получить в документации, которая
поставляется вместе с GNU Emacs. Вы также можете прочитать об этом пакете в русском
переводе руководства по GNU Emacs.

#mh-e
* Пакет *MH-E*

Этот пакет предоставляет доступ к почтовой программе *MH* прямо из Emacs. Этот пакет
поставляется вместе с GNU Emacs, так что нет никакой необходимости устанавливать его
самостоятельно.

Пакет поддерживает чтение и отправку электронной почты, в том числе и сообщений,
соответствующих стандарту *MIME*. Умеет работать с каталогами, в которых вы можете хранить
письма, например, относящиеся к одной теме. Также поддерживается работа с
письмами-дайджестами, и письмами, закодированными программами =shar= и =uuencode=.

#add-packages
* Дополнительные пакеты

** Отправка почты без использования дополнительных пакетов

GNU Emacs умеет отправлять электронную почту без использования каких-либо дополнительных
пакетов. Для создания сообщения используется команда =compose-mail=, которая создает буфер
=*mail*=.

Метод отправки и создания сообщения зависит от того, какое значение имеет переменная
=mail-user-agent=. В настоящее время можно отправлять почту с помощью программы Sendmail,
пакетов Emacs *MH-E*, *Gnus* и *Message*.

Для получения более подробной информации смотрите раздел *Sending Mail* в руководстве по GNU
Emacs.

#sc
** Пакет *Supercite*

Этот пакет позволяет гибко настроить параметры цитирования чужих писем при ответе на них
почтой или в группы Usenet. Пакет поддерживает все основные пакеты Emacs для работы с
почтой и новостями.

Когда вы отвечаете на письмо или статью, то производится вызов функции *Supercite*
=sc-cite-original=, которая осуществляет анализ заголовков исходного текста, запоминая их
параметры. Затем *Supercite* проходится по каждой из строк ответа и изменяет их в
соответствии с заданными функциями преобразования. Оригинальное сообщение может быть
отформатировано в соответствии с вашими предпочтениями во время работы функций *Supercite*.

Для того чтобы любой почтовый пакет Emacs стал использовать *Supercite* для цитирования
писем, вам необходимо вставить в файл инициализации =~/.emacs= следующую строку:

<src lang="emacs-lisp">
(add-hook 'mail-citation-hook 'sc-cite-original)
</src>

Но если вы используете пакет *Gnus*, то вам надо добавить ещё и следующую строку:

<src lang="emacs-lisp">
(setq news-reply-header-hook nil)
</src>

которая предотвратит вставку одинаковых заголовков обоими пакетами. Более полную
информацию вы сможете найти в справочных страницах Info, которые поставляются вместе с
пакетом.

#mailcrypt
** Пакет *Mailcrypt*

Этот пакет является интерфейсом к популярной системе шифрования PGP. Он позволяет работать
как с оригинальным PGP, так и с его свободным клоном -- GnuPG. Использование этих программ
возможно из нескольких пакетов для работы с почтой -- *Gnus*, *VM*, *Rmail*, *MH-E*, *Mew*. Среди
реализованных операций -- шифрование и расшифровка сообщений, подпись сообщений, проверка
электронных подписей. Данный пакет входит в состав дистрибутивов ALTLinux. Кроме того, его
можно скачать с сайта [[http://mailcrypt.sourceforge.net][http://mailcrypt.sourceforge.net]].

Вот как можно заставить *Mailcrypt* работать вместе с пакетом *Gnus*:

<src lang="emacs-lisp">
(load-library "mailcrypt")
(mc-setversion "gpg")
(autoload 'mc-install-write-mode "mailcrypt" nil t)
(autoload 'mc-install-read-mode "mailcrypt" nil t)
(add-hook 'mail-mode-hook 'mc-install-write-mode)
</src>

Первые пять строк одинаковы для всех пакетов работы с почтой. Первая строка загружает
пакет *Mailcrypt*. Вторая строка задает тип программы, которая будет использоваться для
обработки почты (в нашем примере это *gpg* -- GNU-версия программы PGP). Третья и четвертая
строки описывают, что при вызове функций =mc-install-write-mode= и =mc-install-read-mode=
необходимо подгрузить их из библиотеки =mailcrypt=. Пятая строка устанавливает ловушку на
запуск режима работы с почтой (=mail-mode=).

<src lang="emacs-lisp">
(add-hook 'gnus-summary-mode-hook 'mc-install-read-mode)
(add-hook 'message-mode-hook 'mc-install-write-mode)
(add-hook 'news-reply-mode-hook 'mc-install-write-mode)
</src>

Эти команды являются специфическими для пакета *Gnus* и устанавливают "ловушки" на создание
списка сообщений, создание сообщения и режим ответа на сообщение в Usenet.

В составе пакета для GNU Emacs в дистрибутивах ALTLinux поставляется скрипт инициализации,
в котором можно раскомментировать строку, соответствующую используемому вами пакету для
работы с почтой. Полное описание пакета и примеры настройки можно найти в руководстве,
которое поставляется вместе с пакетом.

#&BASEID;.bbdb
* Пакет *BBDB*

Этот пакет позволяет организовать на основе Emacs базу данных для хранения адресов,
телефонов и прочей информации. Пакет обеспечивает интеграцию со многими популярными
пакетами чтения новостей usenet и почты. Существуют утилиты, которые позволяют
экспортировать эту базу данных в формате, понятном для программ синхронизации с популярным
PDA Palm Pilot. Данный пакет входит в состав дистрибутивов ALTLinux. Кроме того, пакет
можно скачать с его [[http://bbdb.sourceforge.net][собственного сайта]].

В руководстве, которое поставляется вместе с *BBDB*, приведены примеры настройки данного
пакета для разных пакетов работы с почтой. Следующий пример демонстрирует настройку пакета
для работы с почтой с помощью пакета *Gnus*:

<src lang="emacs-lisp">
(require 'bbdb)
(bbdb-initialize 'gnus 'message)
(add-hook 'gnus-startup-hook 'bbdb-insinuate-gnus)
(add-hook 'message-setup-hook 'bbdb-define-all-aliases)
(defun my-message-mode-hook () (local-set-key [(tab)] 'bbdb-complete-name))
(setq bbdb-use-pop-up nil)
(defun my-bbdb-tab-complete ()
(interactive)
(if (mail-abbrev-in-expansion-header-p)
(bbdb-complete-name)
(message-tab)))
(define-key message-mode-map [tab] 'my-bbdb-tab-complete)
</src>

Этот пример можно сразу помещать в ваш файл настройки Emacs.  Предварительно стоит
убедиться, что у вас установлены пакеты *Gnus* и *BBDB*.

Первая строка данного примера производит загрузку самого пакета. Вторая строка производит
начальную настройку *BBDB*, указывая, что пакет будет использоваться вместе с пакетом *Gnus*
(*message* -- это специальный режим из поставки *Gnus*, который используется при создании
электронных сообщений. Третья и четвертая строки устанавливают ловушки для правильной
инициализации пакета при запуске соответствующих режимов. Пятая строка устанавливает
локальную привязку клавиши =TAB= для дополнения имен из базы *BBDB*. Шестая строка запрещает
открытие отдельного окна для отображения информации о выбранном пользователе (слишком
частое открытие окна может просто раздражать, поэтому и используется такая настройка).

Строки с седьмой по одиннадцатую определяют функцию, которая производит дополнение имени
только в том случае, если точка находится в почтовом заголовке. Двенадцатая строка
связывает данную функцию с клавишей =TAB= при использовании режима редактирования
электронного сообщения.
